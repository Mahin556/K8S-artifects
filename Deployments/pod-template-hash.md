# Creating a Deployment in Kubernetes

A **Deployment** ensures that a specified number of pod replicas are running at any given time. Below is an example that creates a **ReplicaSet** to manage three Nginx pods.

### Example Deployment YAML: `controllers/nginx-deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
```

---

## Key Points

1. **Deployment Name**

   * `.metadata.name` defines the Deployment name (`nginx-deployment`).
   * This name is used as a basis for the ReplicaSets and Pods created by the Deployment.

2. **Replicas**

   * `.spec.replicas: 3` specifies that **three Nginx pods** should run.

3. **Selector**

   * `.spec.selector.matchLabels` tells the Deployment which pods to manage.
   * Must match the labels defined in the Pod template (`app: nginx`).

> **Note:** The `matchLabels` map is equivalent to a `matchExpressions` rule with operator `In`.

4. **Pod Template**

   * `.spec.template.metadata.labels` labels each Pod with `app: nginx`.
   * `.spec.template.spec.containers` defines the containers to run in each Pod.
   * Here, a single container named `nginx` uses the Nginx image `1.14.2` and exposes port `80`.

5. **Pod-template-hash**

   * Kubernetes adds a `pod-template-hash` label to each ReplicaSet and Pod.
   * This prevents overlap between ReplicaSets and ensures unique identity for each Pod template.
   * **Do not modify this label manually.**

---

## Steps to Deploy

1. Apply the Deployment:

```bash
kubectl apply -f https://k8s.io/examples/controllers/nginx-deployment.yaml
```

2. Check Deployments:

```bash
kubectl get deployments
```

**Output while creating:**

```
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   0/3     0            0           1s
```

3. Check rollout status:

```bash
kubectl rollout status deployment/nginx-deployment
```

**Example output:**

```
Waiting for rollout to finish: 2 out of 3 new replicas have been updated...
deployment "nginx-deployment" successfully rolled out
```

4. Confirm Deployment is complete:

```bash
kubectl get deployments
```

**Expected output:**

```
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           18s
```

---

## Check the ReplicaSet

```bash
kubectl get rs
```

**Example output:**

```
NAME                          DESIRED   CURRENT   READY   AGE
nginx-deployment-75675f5897   3         3         3       18s
```

* `DESIRED` – number of replicas specified in Deployment.
* `CURRENT` – number of Pods currently running.
* `READY` – number of available Pods.

**Note:** ReplicaSet name format: `[DEPLOYMENT-NAME]-[HASH]`. The hash is generated from the Pod template.

---

## Inspect Pod Labels

```bash
kubectl get pods --show-labels
```

**Example output:**

```
NAME                                READY   STATUS    RESTARTS   AGE       LABELS
nginx-deployment-75675f5897-7ci7o   1/1     Running   0          18s       app=nginx,pod-template-hash=75675f5897
nginx-deployment-75675f5897-kzszj   1/1     Running   0          18s       app=nginx,pod-template-hash=75675f5897
nginx-deployment-75675f5897-qqcnn   1/1     Running   0          18s       app=nginx,pod-template-hash=75675f5897
```

* Each ReplicaSet ensures **three Pods are running**.

---

## Important Notes

* Always specify a **selector** and **Pod template labels** in a Deployment.
* Avoid overlapping labels or selectors with other controllers (Deployments, StatefulSets). Conflicts may cause unexpected behavior.
* The **pod-template-hash** is automatically generated by Kubernetes. It ensures each ReplicaSet remains unique. **Do not manually modify this label.**

### References
- https://kubernetes.io/docs/concepts/workloads/controllers/deployment/
